function addToast(e,t){$("#toasts").append(t==TOAST_ERROR?"<div class='error'>"+e+"<span class='close'></span></div>":t==TOAST_WARNING?"<div class='warning'>"+e+"<span class='close'></span></div>":"<div>"+e+"<span class='close'></span></div>"),$("#toasts div:last-child").delay(3600).fadeOut(400,function(){$(this).remove()}),$("#toasts div:last-child .close").on("click",function(){$(this).parent().stop().fadeOut(200,function(){$(this).remove()})})}function assembleField(){if(inputMode==INPUT_NOINPUT){resetCore(coreArray[getSelected()]);var e=$("main section.sel #asm").val(),t=assemble(coreArray[getSelected()],e);null==t.errorMessage?($("main section.sel #machinecode").val(t.machineCode.Oak_hex()),addToast("<b>Complete:</b> Assembly complete, check machine code.",TOAST_NORMAL)):addToast("<b>Assembler Error: </b>"+t.errorMessage,TOAST_ERROR),$("#ShowMC").prop("checked",!0),$("main section.sel #machinecode").stop().slideDown(200)}}function hexToBytes(e){for(var t=e.split(" "),n=[],s=0;s<t.length;s++){var o=parseInt(t[s],16);isNaN(o)||n.push(o)}return n}function getSelected(){return $("main section.sel").index()}function padNo(e,t){for(var n=e,s=0;s<t-e.length;s++)n="0"+n;return n}function updateRegAndMemory(){if(inputMode==INPUT_NOINPUT){var e=coreArray[getSelected()],t=performance.now();switch(console.log("Updating memory/registers..."),regDisplay){case REG_BIN:for(var n=0;32>n;n++){var s="0b"+padNo((registerRead(e,n)>>>0).toString(2),32);$("main section.sel table tbody").children().eq(n).children("td:last-child").html(s)}break;case REG_DEC:for(var n=0;32>n;n++){var s=registerRead(e,n).toString(10);$("main section.sel table tbody").children().eq(n).children("td:last-child").html(s)}break;case REG_UDC:for(var n=0;32>n;n++){var s=(registerRead(e,n)>>>0).toString(10);$("main section.sel table tbody").children().eq(n).children("td:last-child").html(s)}break;case REG_HEX:for(var n=0;32>n;n++){var s="0x"+padNo((registerRead(e,n)>>>0).toString(16),8);$("main section.sel table tbody").children().eq(n).children("td:last-child").html(s)}default:for(var n=0;32>n;n++){var s="0x"+padNo((registerRead(e,n)>>>0).toString(16),8);$("main section.sel table tbody").children().eq(n).children("td:last-child").html(s)}}var o=getMemory(coreArray[getSelected()]);$("main section.sel #memory").html("");for(var n=0;n<o.length;n++){var a=o[n];$("main section.sel #memory").append(padNo(a.toString(16),2)+" ")}var i=performance.now();console.log("Memory/register update done in "+(i-t)+"ms.")}}function selectCommand(e,t){0==t?($("main section.sel p").css("display","none"),$("main section.sel #console").css("display","block")):1==t?($("main section.sel p").css("display","none"),$("main section.sel #instructions").css("display","block")):2==t?($("main section.sel p").css("display","none"),$("main section.sel #memory").css("display","block")):(regDisplay=t-3,updateRegAndMemory()),$("main section.sel select").val("-- Choose an Action --")}function simulateMC(){if(inputMode==INPUT_NOINPUT){var e=$("main section.sel #console").html();e.length>0&&($("main section.sel #console").append("<hr />"),$("main section.sel #instructions").append("<hr />")),resetCore(coreArray[getSelected()]);var t=$("main section.sel #machinecode").val(),n=hexToBytes(t),s=simulate(coreArray[getSelected()],n);"@Oak_Ecall"!==s&&null!=s&&addToast("<b>Simulator Error: </b>"+s,TOAST_ERROR)}}function decodeCallback(e){$("main section.sel #instructions").append("<span>"+e+"</span>")}function addTab(e,t){if(inputMode==INPUT_NOINPUT){$(".tabs span").removeClass("sel"),$(".tabs").append("<span class='sel'><span>"+e+"</span><div class='close'></div></span>"),$("main section").removeClass("sel"),$("main").append(template),$("main section.sel #asm").html(t);var n=ace.edit($("main section.sel #asm").get(0));n.setTheme("ace/theme/sqlserver"),n.getSession().setMode("ace/mode/riscv"),n.getSession().setUseWrapMode(!0),$("main section.sel .grabber").on("mousedown",function(e){var t;t=$(this).parent().children($(this).hasClass("asmDrag")?"#asm":"#machinecode");var s=e.pageY-$(this).position().top+t.position().top;$(document).on("mouseup",function(){$(document).off("mouseup").off("mousemove")}),$(document).on("mousemove",function(e){var o=Math.max(100,e.pageY-s);t.css({height:o}),n.resize()})}),$("main section.sel #machinecode, main section.sel .mcDrag").stop().slideUp(0),$("#ShowMC").prop("checked",!1),coreArray.push(new RISCVCore(2048,invokeEnvironmentCall,decodeCallback)),$(".tabs span:last-child").on("click",function(){if(inputMode==INPUT_NOINPUT){$(".tabs span").removeClass("sel"),$(this).addClass("sel"),$("main section").removeClass("sel"),$("main").children().eq($(this).index()).addClass("sel");var e="none"!=$("main section.sel #machinecode").css("display");if($("#ShowMC").prop("checked",e),1==$("section.sel .insertable").length){var t=$("section.sel .insertable").html();counter=t.length}}}),$(".tabs span:last-child .close").on("click",function(){closeTab($(this).parent().index())}),$(".tabs span:last-child").dblclick(function(e){var t=$(this).children(":first-child").html();$(this).children(":first-child").remove(),$(this).prepend("<input value='"+t+"'>").focus(),$(this).children(":first-child").on("blur",function(){var e=$(this).val();$(this).parent().prepend("<span>"+e+"</span>"),$(this).remove()}),e.preventDefault()}),$("main section.sel select").on("change",function(){var e=$("option:selected",this).attr("id");selectCommand($(this).parent().index(),e)});for(var s=getRegisterABINames(coreArray[getSelected()]),o=0;o<s.length;o++)$("main section.sel tbody").append("<tr><td>"+s[o]+"</td><td>0x00000000</td></tr>")}}function closeTab(e){inputMode==INPUT_NOINPUT&&(coreArray.splice(e,1),$("main").children().eq(e).remove(),$(".tabs").children().eq(e).remove())}function processKey(e){if(e.preventDefault(),inputMode!=INPUT_NOINPUT)if(13==e.keyCode){registerWrite(coreArray[getSelected()],17,parseInt($("section.sel .insertable").html())),$("section.sel .insertable").removeClass("insertable"),$("section.sel #console").append("<br />"),cursor=0,inputMode=INPUT_NOINPUT,$("section.sel #asm").prop("disabled",!1),$("section.sel #machinecode").prop("disabled",!1),$("#fileInputElement").prop("disabled",!1),$("#asmInputElement").prop("disabled",!1),updateRegAndMemory();var t=continueSim(coreArray[getSelected()]);"@Oak_Ecall"!==t&&null!=t&&addToast("<b>Simulator Error: </b>"+t,TOAST_ERROR)}else if(189==e.keyCode)$("section.sel .insertable").append("-"),cursor++;else if(37==e.keyCode)cursor--,0>cursor&&(cursor=0);else if(39==e.keyCode){cursor++;var n=$("section.sel .insertable").html().length;n>cursor||(cursor=n-1)}else if(8==e.keyCode){if(cursor>0){var s=$("section.sel .insertable").html();s=s.slice(0,cursor-1)+s.slice(cursor),$("section.sel .insertable").html(s),cursor--}}else if(46==e.keyCode){var n=$("section.sel .insertable").html().length;if(n>=cursor){var s=$("section.sel .insertable").html();s=s.slice(0,cursor)+s.slice(cursor+1),$("section.sel .insertable").html(s),cursor--}}else if(e.keyCode<48||e.keyCode>57){if(e.keyCode>=65&&e.keyCode<=90&&inputMode==INPUT_ALPHANUMERIC){var s=$("section.sel .insertable").html();s=s.slice(0,cursor-1)+(keyCode-48)+s.slice(cursor),$("section.sel .insertable").html(s),cursor++}}else{var s=$("section.sel .insertable").html();s=s.slice(0,cursor)+(e.keyCode-48)+s.slice(cursor),$("section.sel .insertable").html(s),cursor++}}function invokeEnvironmentCall(){var e=coreArray[getSelected()],t=registerRead(e,17),n=registerRead(e,10);selectCommand(0);var s=!1;switch(t){case 1:$("section.sel #console").append("<span>"+n+"</span>");break;case 4:for(var o=n,a="",i=e.memory[o];0!=i;)a+=String.fromCharCode(i),o+=1,i=e.memory[o];console.log(a),$("section.sel #console").append("<span>"+a+"</span>");break;case 5:return updateRegAndMemory(),inputMode=INPUT_NUMERICAL,$("section.sel #console").append("<span class='input insertable'></span>"),$("section.sel #asm").prop("disabled",!0),$("section.sel #machinecode").prop("disabled",!0),$("#fileInputElement").prop("disabled",!0),void $("#asmInputElement").prop("disabled",!0);case 10:s=!0;break;default:addToast("<b>WARNING:</b> Environment call "+t+"unsupported.",TOAST_WARNING)}if(s)updateRegAndMemory(),addToast("<b>Complete:</b> Simulation complete.",TOAST_NORMAL);else{var a=continueSim(coreArray[getSelected()]);"@Oak_Ecall"!=a&&null!=a&&addToast("<b>Simulator Error: </b>"+a,TOAST_ERROR)}}var coreArray=[],TOAST_NORMAL=0,TOAST_WARNING=1,TOAST_ERROR=2,INPUT_NOINPUT=0,INPUT_NUMERICAL=1,INPUT_ALPHANUMERIC=2,cursor=0,inputMode=INPUT_NOINPUT;$("#ShowMC").on("change",function(){1==$(this).prop("checked")?$("main section.sel #machinecode, main section.sel .mcDrag").stop().slideDown(200):$("main section.sel #machinecode, main section.sel .mcDrag").stop().slideUp(200)}),$(".assemble").on("click",function(){assembleField()});var REG_HEX=0,REG_DEC=1,REG_UDC=2,REG_BIN=3,regDisplay=REG_HEX;$(".stepbystep").on("click",function(){inputMode==INPUT_NOINPUT&&loadMemStep(core,data)}),$(".simulate").on("click",function(){simulateMC()});var template="<section class='sel'><div id='asm'></div><div class='grabber asmDrag'></div><textarea rows='8' id='machinecode' placeholder='Machine Code'></textarea><div class='grabber mcDrag'></div><div class='output'><p id='console'></p><p id='instructions'></p><p id='memory'></p><div class='side'><select><option id='-1'>-- Choose an Action --</option><optgroup label='Console Display'><option id='0'>Output</option><option id='1'>Instructions</option><option id='2'>Memory</option></optgroup><optgroup label='Register Format'><option id='3'>Hexadecimal</option><option id='4'>Decimal</option><option id='5'>Unsigned Decimal</option><option id='6'>Binary</option></optgroup></select><table><thead><tr><th>Register</th><th>Data</th></tr></thead><tbody></tbody></table></div></div></section>";$(".addTab").on("click",function(){addTab("Untitled",'.data\n    text: .string "word"\n    .text\nmain:\n    add x3, x2, x1\n    addi x4, x1, x3\n    li a7, 5\n    scall              # Get Input\n    addi a0, a7, 0x241\n    li a7, 1\n    scall              # Output = Input + 5\n    li a7, 10\n    scall              # Quit')}),$(document).ready(function(){addTab("Untitled",'.data\n    text: .string "word"\n    .text\nmain:\n    add x3, x2, x1\n    addi x4, x1, x3\n    li a7, 5\n    scall              # Get Input\n    addi a0, a7, 0x241\n    li a7, 1\n    scall              # Output = Input + 5\n    li a7, 10\n    scall              # Quit'),$(document).on("keyup",function(e){processKey(e)}),window.File&&window.FileReader&&window.FileList&&window.Blob?($("#fileInputElement").on("change",function(){var e=$(this)[0].files;if(!e.length)return void addToast("<b>No Files: </b> Please choose files to upload one.",TOAST_WARNING);var t=e[0];addTab(t.name,"");var n=t.slice(0,t.size),s=new FileReader;s.addEventListener("load",function(){for(var e=new Uint8Array(this.result),t="",n=0;n<e.length;n++)t+=e[n]<16?"0"+e[n].toString(16).toUpperCase()+" ":e[n].toString(16).toUpperCase()+" ";$("#ShowMC").prop("checked",!0),$("main section.sel #machinecode, main section.sel .mcDrag").val(t).stop().slideDown(200)}),s.readAsArrayBuffer(n)}),$("#asmInputElement").on("change",function(){var e=$(this)[0].files;if(!e.length)return void addToast("<b>No file chosen.</b>",TOAST_WARNING);var t=e[0],n=t.slice(0,t.size),s=new FileReader;s.addEventListener("load",function(){addTab(t.name,this.result)}),s.readAsText(n)}),$(".download").on("click",function(){var e=$("main section.sel #asm").val(),t=document.createElement("a"),n=new Blob([e],{type:"text/plain"}),s=URL.createObjectURL(n),o=$(".tabs span.sel span").html()+".S";t.setAttribute("href",s),t.setAttribute("download",o),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}),$(".downloadBin").on("click",function(){var e=$("main section.sel #machinecode").val(),t=new Uint8Array(hexToBytes(e)),n=new Blob([t],{type:"application/octet-stream"}),s=URL.createObjectURL(n),o=document.createElement("a"),a=$(".tabs span.sel span").html()+".bin";o.setAttribute("href",s),o.setAttribute("download",a),o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o)})):$(".download, .downloadBin, .asmUpload, .fileUpload").remove()});