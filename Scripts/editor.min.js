function addToast(str,type){type==TOAST_ERROR?$("#toasts").append("<div class='error'>"+str+"<span class='close'></span></div>"):type==TOAST_WARNING?$("#toasts").append("<div class='warning'>"+str+"<span class='close'></span></div>"):$("#toasts").append("<div>"+str+"<span class='close'></span></div>"),$("#toasts div:last-child").delay(3600).fadeOut(400,function(){$(this).remove()}),$("#toasts div:last-child .close").on("click",function(){$(this).parent().stop().fadeOut(200,function(){$(this).remove()})})}function assembleField(){if(inputMode==INPUT_NOINPUT){resetCore(coreArray[getSelected()]);var val=ace.edit($("main section.sel #asm").get(0)).getValue(),output=assemble(coreArray[getSelected()],val);null==output.errorMessage?($("main section.sel #machinecode").val(output.machineCode.Oak_hex()),addToast("<b>Complete:</b> Assembly Complete.",TOAST_NORMAL)):addToast("<b>Assembler Error: </b>"+output.errorMessage,TOAST_ERROR),$("#ShowMC").prop("checked",!0),$("main section.sel #machinecode").stop().slideDown(200)}}function hexToBytes(hex){for(var hexArr=hex.split(" "),byteArr=[],i=0;i<hexArr.length;i++){var value=parseInt(hexArr[i],16);isNaN(value)||byteArr.push(value)}return byteArr}function getSelected(){return $("main section.sel").index()}function padNo(str,length){for(var padded=str,i=0;i<length-str.length;i++)padded="0"+padded;return padded}function updateRegAndMemory(){if(inputMode==INPUT_NOINPUT){var core=coreArray[getSelected()],t0=performance.now();switch(console.log("Updating memory/registers..."),regDisplay){case REG_BIN:for(var i=0;i<32;i++){var formatted="0b"+padNo((registerRead(core,i)>>>0).toString(2),32);$("main section.sel table tbody").children().eq(i).children("td:last-child").html(formatted)}break;case REG_DEC:for(var i=0;i<32;i++){var formatted=registerRead(core,i).toString(10);$("main section.sel table tbody").children().eq(i).children("td:last-child").html(formatted)}break;case REG_UDC:for(var i=0;i<32;i++){var formatted=(registerRead(core,i)>>>0).toString(10);$("main section.sel table tbody").children().eq(i).children("td:last-child").html(formatted)}break;case REG_HEX:for(var i=0;i<32;i++){var formatted="0x"+padNo((registerRead(core,i)>>>0).toString(16),8);$("main section.sel table tbody").children().eq(i).children("td:last-child").html(formatted)}default:for(var i=0;i<32;i++){var formatted="0x"+padNo((registerRead(core,i)>>>0).toString(16),8);$("main section.sel table tbody").children().eq(i).children("td:last-child").html(formatted)}}var memory=getMemory(coreArray[getSelected()]);$("main section.sel #memory").html("");for(var i=0;i<memory.length;i++){var memOut=memory[i];$("main section.sel #memory").append(padNo(memOut.toString(16),2)+" ")}var t1=performance.now();console.log("Memory/register update done in "+(t1-t0)+"ms.")}}function selectCommand(id,data){0==data?($("main section.sel p").css("display","none"),$("main section.sel #console").css("display","block")):1==data?($("main section.sel p").css("display","none"),$("main section.sel #instructions").css("display","block")):2==data?($("main section.sel p").css("display","none"),$("main section.sel #memory").css("display","block")):(regDisplay=data-3,updateRegAndMemory()),$("main section.sel select").val("-- Choose an Action --")}function simulateMC(){if(inputMode==INPUT_NOINPUT){var consoleContents=$("main section.sel #console").html();consoleContents.length>0&&($("main section.sel #console").append("<hr />"),$("main section.sel #instructions").append("<hr />")),resetCore(coreArray[getSelected()]);var val=$("main section.sel #machinecode").val(),bytes=hexToBytes(val),output=simulate(coreArray[getSelected()],bytes);"@Oak_Ecall"!==output&&null!=output&&addToast("<b>Simulator Error: </b>"+output,TOAST_ERROR)}}function decodeCallback(data){$("main section.sel #instructions").append("<span>"+data+"</span>")}function addTab(tabTitle,asmContent){if(inputMode==INPUT_NOINPUT){$(".tabs span").removeClass("sel"),$(".tabs").append("<span class='sel'><span>"+tabTitle+"</span><div class='close'></div></span>"),$("main section").removeClass("sel"),$("main").append(template),$("main section.sel #asm").html(asmContent);var editor=ace.edit($("main section.sel #asm").get(0));editor.setOption("firstLineNumber",0),editor.setTheme("ace/theme/oak"),editor.getSession().setMode("ace/mode/riscv"),editor.getSession().setUseWrapMode(!0),$("main section.sel .grabber").on("mousedown",function(e){var $element;$element=$(this).hasClass("asmDrag")?$(this).parent().children("#asm"):$(this).parent().children("#machinecode");var pY=e.pageY-$(this).position().top+$element.position().top;$(document).on("mouseup",function(e){$(document).off("mouseup").off("mousemove")}),$(document).on("mousemove",function(me){var mx=Math.max(100,me.pageY-pY);$element.css({height:mx}),editor.resize()})}),$("main section.sel #machinecode, main section.sel .mcDrag").stop().slideUp(0),$("#ShowMC").prop("checked",!1),coreArray.push(new RISCVCore(2048,invokeEnvironmentCall,decodeCallback)),$(".tabs span:last-child").on("click",function(){if(inputMode==INPUT_NOINPUT){$(".tabs span").removeClass("sel"),$(this).addClass("sel"),$("main section").removeClass("sel"),$("main").children().eq($(this).index()).addClass("sel");var machineCodeEnabled="none"!=$("main section.sel #machinecode").css("display");if($("#ShowMC").prop("checked",machineCodeEnabled),1==$("section.sel .insertable").length){var words=$("section.sel .insertable").html();counter=words.length}}}),$(".tabs span:last-child .close").on("click",function(){closeTab($(this).parent().index())}),$(".tabs span:last-child").dblclick(function(e){var val=$(this).children(":first-child").html();$(this).children(":first-child").remove(),$(this).prepend("<input value='"+val+"'>").focus(),$(this).children(":first-child").on("blur",function(){var val=$(this).val();$(this).parent().prepend("<span>"+val+"</span>"),$(this).remove()}),e.preventDefault()}),$("main section.sel select").on("change",function(){var data=$("option:selected",this).attr("id");selectCommand($(this).parent().index(),data)});for(var names=getRegisterABINames(coreArray[getSelected()]),i=0;i<names.length;i++)$("main section.sel tbody").append("<tr><td>"+names[i]+"</td><td>0x00000000</td></tr>")}}function closeTab(id){inputMode==INPUT_NOINPUT&&(coreArray.splice(id,1),$("main").children().eq(id).remove(),$(".tabs").children().eq(id).remove())}function processKey(event){if(event.preventDefault(),inputMode!=INPUT_NOINPUT)if(13==event.keyCode){registerWrite(coreArray[getSelected()],17,parseInt($("section.sel .insertable").html())),$("section.sel .insertable").removeClass("insertable"),$("section.sel #console").append("<br />"),cursor=0,inputMode=INPUT_NOINPUT,$("section.sel #asm").prop("disabled",!1),$("section.sel #machinecode").prop("disabled",!1),$("#fileInputElement").prop("disabled",!1),$("#asmInputElement").prop("disabled",!1),updateRegAndMemory();var output=continueSim(coreArray[getSelected()]);"@Oak_Ecall"!==output&&null!=output&&addToast("<b>Simulator Error: </b>"+output,TOAST_ERROR)}else if(189==event.keyCode)$("section.sel .insertable").append("-"),cursor++;else if(37==event.keyCode)cursor--,cursor<0&&(cursor=0);else if(39==event.keyCode){cursor++;var maxLen=$("section.sel .insertable").html().length;cursor>=maxLen&&(cursor=maxLen-1)}else if(8==event.keyCode){if(cursor>0){var content=$("section.sel .insertable").html();content=content.slice(0,cursor-1)+content.slice(cursor),$("section.sel .insertable").html(content),cursor--}}else if(46==event.keyCode){var maxLen=$("section.sel .insertable").html().length;if(cursor<=maxLen){var content=$("section.sel .insertable").html();content=content.slice(0,cursor)+content.slice(cursor+1),$("section.sel .insertable").html(content),cursor--}}else if(event.keyCode>=48&&event.keyCode<=57){var content=$("section.sel .insertable").html();content=content.slice(0,cursor)+(event.keyCode-48)+content.slice(cursor),$("section.sel .insertable").html(content),cursor++}else if(event.keyCode>=65&&event.keyCode<=90&&inputMode==INPUT_ALPHANUMERIC){var content=$("section.sel .insertable").html();content=content.slice(0,cursor-1)+(keyCode-48)+content.slice(cursor),$("section.sel .insertable").html(content),cursor++}}function invokeEnvironmentCall(){var core=coreArray[getSelected()],type=registerRead(core,17),arg=registerRead(core,10);selectCommand(0);var exit=!1;switch(type){case 1:$("section.sel #console").append("<span>"+arg+"</span>");break;case 4:for(var pointer=arg,output="",char=core.memory[pointer];0!=char;)output+=String.fromCharCode(char),pointer+=1,char=core.memory[pointer];console.log(output),$("section.sel #console").append("<span>"+output+"</span>");break;case 5:return updateRegAndMemory(),inputMode=INPUT_NUMERICAL,$("section.sel #console").append("<span class='input insertable'></span>"),$("section.sel #asm").prop("disabled",!0),$("section.sel #machinecode").prop("disabled",!0),$("#fileInputElement").prop("disabled",!0),void $("#asmInputElement").prop("disabled",!0);case 10:exit=!0;break;default:addToast("<b>WARNING:</b> Environment call "+type+"unsupported.",TOAST_WARNING)}if(exit)updateRegAndMemory(),addToast("<b>Complete:</b> Simulation complete.",TOAST_NORMAL);else{var output=continueSim(coreArray[getSelected()]);"@Oak_Ecall"!=output&&null!=output&&addToast("<b>Simulator Error: </b>"+output,TOAST_ERROR)}}var coreArray=[],TOAST_NORMAL=0,TOAST_WARNING=1,TOAST_ERROR=2,INPUT_NOINPUT=0,INPUT_NUMERICAL=1,INPUT_ALPHANUMERIC=2,cursor=0,inputMode=INPUT_NOINPUT,defaultCode='    la a0, str\n    li a7, 4 #4 is the string print service number...\n    ecall\n    li a7, 10 #...and 10 is the program termination service number!\n    ecall\n.data\nstr:    .string "Hello, World!"';$("#ShowMC").on("change",function(){$(this).prop("checked")?$("main section.sel #machinecode, main section.sel .mcDrag").stop().slideDown(200):$("main section.sel #machinecode, main section.sel .mcDrag").stop().slideUp(200)}),$(".assemble").on("click",function(){assembleField()});var REG_HEX=0,REG_DEC=1,REG_UDC=2,REG_BIN=3,regDisplay=REG_HEX;$(".stepbystep").on("click",function(){inputMode==INPUT_NOINPUT&&loadMemStep(core,data)}),$(".simulate").on("click",function(){simulateMC()});var template="<section class='sel'><div id='asm'></div><div class='grabber asmDrag'></div><textarea rows='8' id='machinecode' placeholder='Machine Code'></textarea><div class='grabber mcDrag'></div><div class='output'><p id='console'></p><p id='instructions'></p><p id='memory'></p><div class='side'><select><option id='-1'>-- Choose an Action --</option><optgroup label='Console Display'><option id='0'>Output</option><option id='1'>Instructions</option><option id='2'>Memory</option></optgroup><optgroup label='Register Format'><option id='3'>Hexadecimal</option><option id='4'>Decimal</option><option id='5'>Unsigned Decimal</option><option id='6'>Binary</option></optgroup></select><table><thead><tr><th>Register</th><th>Data</th></tr></thead><tbody></tbody></table></div></div></section>";$(".addTab").on("click",function(){addTab("Untitled.S",defaultCode)}),$(document).ready(function(){addTab("Untitled.S",defaultCode),$(document).on("keyup",function(event){processKey(event)}),window.File&&window.FileReader&&window.FileList&&window.Blob?($("#fileInputElement").on("change",function(evt){var files=$(this)[0].files;if(!files.length)return void addToast("<b>No Files: </b> Please choose files to upload one.",TOAST_WARNING);var file=files[0];addTab(file.name,"");var blob=file.slice(0,file.size),fr=new FileReader;fr.addEventListener("load",function(){for(var bytes=new Uint8Array(this.result),hexer="",i=0;i<bytes.length;i++)hexer+=bytes[i]<16?"0"+bytes[i].toString(16).toUpperCase()+" ":bytes[i].toString(16).toUpperCase()+" ";$("#ShowMC").prop("checked",!0),$("main section.sel #machinecode, main section.sel .mcDrag").val(hexer).stop().slideDown(200)}),fr.readAsArrayBuffer(blob)}),$("#asmInputElement").on("change",function(evt){var files=$(this)[0].files;if(!files.length)return void addToast("<b>No file chosen.</b>",TOAST_WARNING);var file=files[0],blob=file.slice(0,file.size),fr=new FileReader;fr.addEventListener("load",function(){addTab(file.name,this.result)}),fr.readAsText(blob)}),$(".download").on("click",function(){var link=$("main section.sel #asm").val(),el=document.createElement("a"),blob=new Blob([link],{type:"text/plain"}),blobLink=URL.createObjectURL(blob),name=$(".tabs span.sel span").html()+".S";el.setAttribute("href",blobLink),el.setAttribute("download",name),el.style.display="none",document.body.appendChild(el),el.click(),document.body.removeChild(el)}),$(".downloadBin").on("click",function(){var hexdata=$("main section.sel #machinecode").val(),byteArray=new Uint8Array(hexToBytes(hexdata)),blob=new Blob([byteArray],{type:"application/octet-stream"}),blobLink=URL.createObjectURL(blob),element=document.createElement("a"),filename=$(".tabs span.sel span").html()+".bin";element.setAttribute("href",blobLink),element.setAttribute("download",filename),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)})):$(".download, .downloadBin, .asmUpload, .fileUpload").remove()});
